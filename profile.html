<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>OP.GG Clone - Jaydmj23</title>
    <style>
        :root {
            --bg-body: #1c1c1f;
            --bg-card: #31313c;
            --border-color: #2c2c32;
            --win-blue: #5383e8;
            --lose-red: #e84057;
            --text-primary: #fff;
            --text-secondary: #9e9eb1;
            --win-bg: #28344e;
            --lose-bg: #59343b;
        }
        body { font-family: sans-serif; background-color: var(--bg-body); color: var(--text-primary); margin: 0; padding: 20px; font-size: 12px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* HEADER */
        .header { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
        .profile-icon-img { width: 100px; height: 100px; border-radius: 20px; border: 4px solid var(--bg-card); }
        .header-info h1 { font-size: 24px; margin: 0; font-weight: bold; }
        .tag { color: var(--text-secondary); font-weight: normal; }
        .update-btn { margin-top: 10px; background: var(--win-blue); border: none; color: white; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .update-btn:active { transform: scale(0.98); }

        /* GRID */
        .content { display: grid; grid-template-columns: 300px 1fr; gap: 10px; }

        /* SIDEBAR */
        .rank-card { background: var(--bg-card); border-radius: 4px; padding: 15px; display: flex; align-items: center; gap: 12px; margin-bottom: 8px; border: 1px solid var(--border-color); }
        .tier-img { width: 72px; background: #1c1c1f; border-radius: 50%; padding: 4px; }
        .tier-text { font-size: 15px; font-weight: bold; color: var(--win-blue); }
        .side-title { background: var(--bg-card); padding: 10px 15px; font-size: 12px; color: var(--text-secondary); border-radius: 4px 4px 0 0; border-bottom: 1px solid var(--border-color); margin-top: 10px; }
        .champ-stats-list { background: var(--bg-card); padding: 0; border-radius: 0 0 4px 4px; }
        .champ-stat-row { display: flex; align-items: center; padding: 8px 15px; border-bottom: 1px solid var(--border-color); }
        .cs-icon { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; }
        .cs-info { flex: 1; }
        .cs-name { font-weight: bold; font-size: 13px; color: #fff; }
        .cs-detail { font-size: 11px; color: var(--text-secondary); }
        .cs-winrate { text-align: right; }
        .wr-val.good { color: var(--win-blue); } .wr-val.bad { color: var(--lose-red); }
        .mate-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; border-bottom: 1px solid var(--border-color); }

        /* MAIN */
        .stats-box { background: var(--bg-card); border-radius: 4px; border: 1px solid var(--border-color); padding: 12px 24px; margin-bottom: 10px; display: flex; align-items: center; gap: 30px; }
        .donut-chart { width: 90px; height: 90px; border-radius: 50%; background: conic-gradient(var(--win-blue) 0% 50%, var(--lose-red) 50% 100%); display: flex; align-items: center; justify-content: center; }
        .donut-inner { width: 64px; height: 64px; background: var(--bg-card); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2; font-weight: bold; font-size: 14px; }
        
        .game-card { margin-bottom: 8px; border-radius: 4px; overflow: hidden; background: var(--bg-card); border: 1px solid var(--border-color); }
        .game-summary { display: flex; height: 96px; border-left: 6px solid; align-items: center; position: relative; }
        .game-card.win .game-summary { background-color: var(--win-bg); border-left-color: var(--win-blue); }
        .game-card.lose .game-summary { background-color: var(--lose-bg); border-left-color: var(--lose-red); }
        
        .info-col { width: 100px; text-align: center; color: var(--text-secondary); font-size: 11px; }
        .result { font-weight: bold; font-size: 13px; margin-bottom: 4px; }
        .win .result { color: var(--win-blue); } .lose .result { color: var(--lose-red); }
        
        .champ-col { width: 100px; display: flex; gap: 6px; align-items: center; }
        .champ-icon { width: 48px; height: 48px; border-radius: 50%; }
        .spells { display: flex; flex-direction: column; gap: 2px; }
        .spell-img, .rune-img { width: 22px; height: 22px; border-radius: 4px; background: #000; }
        
        .kda-col { width: 120px; text-align: center; }
        .kda-text { font-size: 15px; font-weight: bold; display: block; margin-bottom: 4px; }
        .stats-col { width: 110px; font-size: 11px; color: var(--text-secondary); border-left: 1px solid rgba(255,255,255,0.05); padding-left: 12px; }
        .items-col { margin-left: auto; display: flex; gap: 2px; margin-right: 40px; }
        .item-box { width: 22px; height: 22px; border-radius: 3px; background: rgba(0,0,0,0.3); }
        .item-box img { width: 100%; height: 100%; border-radius: 3px; }
        
        .btn-expand { position: absolute; right: 0; bottom: 0; width: 30px; height: 100%; background: rgba(0,0,0,0.1); border: none; color: #fff; cursor: pointer; }
        .game-details { display: none; background: #23232d; }
        .team-header { padding: 8px 10px; font-size: 11px; font-weight: bold; border-bottom: 1px solid var(--border-color); background: rgba(0,0,0,0.2); display: flex; justify-content: space-between;}
        .team-blue .team-header { color: var(--win-blue); } .team-red .team-header { color: var(--lose-red); }
        
        .player-row { height: 32px; display: flex; align-items: center; padding: 0 10px; border-bottom: 1px solid #282830; }
        .player-row.is-me { background: rgba(83, 131, 232, 0.1); }
        .c-name { width: 100px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; margin-right: 10px; color: #fff; font-size: 11px; }
        .c-kda { width: 80px; text-align: center; font-size: 11px; color: #888; }
        .c-damage { width: 80px; margin: 0 10px; text-align: center; }
        .dmg-bar { width: 100%; height: 6px; background: #2f2f35; }
        .dmg-fill { height: 100%; background: var(--lose-red); }
        .mini-item { width: 22px; height: 22px; background: #1c1c1f; border-radius: 3px; margin-left: 1px;}
        .mini-item img { width: 100%; height: 100%; border-radius: 3px; }
        .badge { padding: 1px 3px; border-radius: 3px; font-size: 9px; font-weight: bold; color: #fff; margin-left: 5px;}
        .badge-mvp { background: #e19205; } .badge-ace { background: #6c3cd4; } .badge-rank { background: #3b3b44; }

        /* BOUTON LOAD MORE */
        .load-more-container { text-align: center; margin-top: 10px; padding-bottom: 40px; }
        .btn-load-more { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 10px 40px; width: 100%; border-radius: 4px; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .btn-load-more:hover { background: #3a3a45; color: #fff; }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img id="p-icon" class="profile-icon-img" src="" alt="">
        <div class="header-info">
            <h1 id="p-name">Chargement...</h1>
            <div class="tag">Ladder Rank: Top 15% (Approx)</div>
            <button id="update-btn" class="update-btn" onclick="updateData()">Update</button>
            <div style="font-size:10px; color:#666; margin-top:5px;">* Lancez le script Python pour actualiser les données réelles</div>
        </div>
    </div>

    <div class="content">
        <div class="sidebar">
            <div id="ranks-container"></div>
            <div class="side-title">S2025 Champions</div>
            <div id="champions-list" class="champ-stats-list"></div>
            <div class="side-title">Recently Played With</div>
            <div id="teammates-list" class="champ-stats-list"></div>
        </div>

        <div class="main">
            <div class="stats-box">
                <div class="donut-chart" id="winrate-chart"><div class="donut-inner" id="winrate-text">0%</div></div>
                <div>
                    <div class="kda-big" id="kda-display">0.0 / 0.0 / 0.0</div>
                    <div style="color:var(--text-secondary);" id="kda-ratio-display">0.00:1 KDA</div>
                </div>
            </div>

            <div id="games-container"></div>
            
            <div class="load-more-container">
                <button id="btn-load-more" class="btn-load-more" onclick="loadMoreGames()">Voir plus</button>
            </div>
        </div>
    </div>
</div>

<script>
    const D_DRAGON_IMG = "https://ddragon.leagueoflegends.com/cdn/14.23.1/img";
    const CDN = "https://raw.communitydragon.org/latest/plugins/rcp-be-lol-game-data/global/default/v1";
    const spellMap = {1: "SummonerBoost", 3: "SummonerExhaust", 4: "SummonerFlash", 6: "SummonerHaste", 7: "SummonerHeal", 11: "SummonerSmite", 12: "SummonerTeleport", 14: "SummonerDot", 21: "SummonerBarrier", 32: "SummonerSnowball"};

    let fullHistory = [];
    let displayedCount = 20; // On commence par 20 games

    // Fonction Update (Reload)
    function updateData() {
        const btn = document.getElementById('update-btn');
        btn.innerText = "Updating...";
        btn.style.background = "#333";
        setTimeout(() => {
            location.reload(); // Rafraîchir la page pour lire le nouveau JSON
        }, 1000);
    }

    fetch('opgg_clone_data.json')
        .then(res => res.json())
        .then(data => {
            fullHistory = data.history;
            const profile = data.profile;
            const stats = data.stats_summary;

            // Header & Profil
            document.getElementById('p-name').innerHTML = `${profile.name} <span class="tag">#${profile.tag}</span>`;
            document.getElementById('p-icon').src = profile.icon_url;

            // Rangs Sidebar
            const rankDiv = document.getElementById('ranks-container');
            // On utilise les infos précises du script Python (profile.rank_solo)
            if (profile.rank_solo && profile.rank_solo.tier !== "Unranked") {
                const r = profile.rank_solo;
                let tierName = r.tier.split(' ')[0].toLowerCase();
                rankDiv.innerHTML = `
                    <div class="rank-card">
                        <img src="https://opgg-static.akamaized.net/images/medals_new/${tierName}.png" class="tier-img" onerror="this.src='https://opgg-static.akamaized.net/images/medals_new/provisional.png'">
                        <div>
                            <div style="color:#999; font-size:11px;">Ranked Solo</div>
                            <div class="tier-text">${r.tier}</div>
                            <div style="font-weight:bold;">${r.lp}</div>
                            <div style="font-size:11px; color:#888;">${r.winrate}</div>
                        </div>
                    </div>`;
            } else {
                rankDiv.innerHTML = `<div class="rank-card"><div>Unranked</div></div>`;
            }

            // Stats Champions (Sidebar)
            const champList = document.getElementById('champions-list');
            data.champions_stats.slice(0, 5).forEach(c => {
                const wrColor = c.winrate >= 60 ? 'good' : (c.winrate < 50 ? 'bad' : '');
                champList.innerHTML += `
                    <div class="champ-stat-row">
                        <img src="${CDN}/champion-icons/${c.id}.png" class="cs-icon">
                        <div class="cs-info">
                            <div class="cs-name">CS ${c.cs}</div>
                            <div class="cs-detail">${c.kda} KDA</div>
                        </div>
                        <div class="cs-winrate">
                            <div class="wr-val ${wrColor}">${c.winrate}%</div>
                            <div class="wr-count">${c.games} Games</div>
                        </div>
                    </div>`;
            });

            // Teammates (Sidebar)
            const mateList = document.getElementById('teammates-list');
            if(data.recent_teammates.length > 0) {
                data.recent_teammates.slice(0, 5).forEach(m => {
                    mateList.innerHTML += `
                        <div class="mate-row">
                            <div class="mate-name">${m.name}</div>
                            <div style="text-align:right;">
                                <span style="color:${m.winrate>=50?'#5383e8':'#e84057'}; font-weight:bold;">${m.winrate}%</span>
                                <span style="color:#666">(${m.wins}W-${m.losses}L)</span>
                            </div>
                        </div>`;
                });
            } else {
                mateList.innerHTML = "<div style='padding:10px; color:#666; text-align:center;'>Pas assez de données</div>";
            }

            // Donut Chart
            if(stats.total_games > 0) {
                const wr = Math.round((stats.wins / stats.total_games) * 100);
                document.getElementById('winrate-text').innerText = `${wr}%`;
                document.getElementById('winrate-chart').style.background = `conic-gradient(#5383e8 0% ${wr}%, #e84057 ${wr}% 100%)`;
                document.getElementById('kda-display').innerText = `${(stats.kills/stats.total_games).toFixed(1)} / ${(stats.deaths/stats.total_games).toFixed(1)} / ${(stats.assists/stats.total_games).toFixed(1)}`;
                document.getElementById('kda-ratio-display').innerText = `${((stats.kills+stats.assists)/Math.max(1,stats.deaths)).toFixed(2)}:1 KDA`;
            }

            // Initial Render
            renderGamesList();
        });

    // Fonction d'affichage des games (Pagination)
    function renderGamesList() {
        const container = document.getElementById('games-container');
        // On n'efface PAS le container, on ajoute si besoin, ou on efface tout si c'est le premier load
        // Ici on va faire simple : on re-render tout ce qui doit être affiché jusqu'à displayedCount
        
        container.innerHTML = ""; // Reset pour simplifier logic
        const gamesToShow = fullHistory.slice(0, displayedCount);

        gamesToShow.forEach((game, index) => {
            const me = game.my_stats;
            const isWin = game.result === "WIN";
            const resultClass = isWin ? "win" : "lose";
            
            // Calcul Max Damage
            let maxDmg = 0;
            [...game.teams.BLUE, ...game.teams.RED].forEach(p => maxDmg = Math.max(maxDmg, p.damage));

            const renderPlayer = (p) => {
                const isMe = p.is_me ? "is-me" : "";
                const dmgPercent = Math.round((p.damage / maxDmg) * 100);
                const items = p.items.map(id => id ? `<div class="mini-item"><img src="${D_DRAGON_IMG}/item/${id}.png"></div>` : `<div class="mini-item"></div>`).join('');
                
                // Badge Logic
                let badge = "";
                if(p.op_rank===1) badge = `<span class="badge badge-mvp">MVP</span>`;
                else if(p.op_rank===2) badge = `<span class="badge badge-ace">ACE</span>`;
                else if(p.op_rank<=4) badge = `<span class="badge badge-rank">${p.op_rank}th</span>`;

                const spell1 = spellMap[p.spells[0]] || "SummonerFlash";
                const spell2 = spellMap[p.spells[1]] || "SummonerFlash";
                const runeUrl = p.runes ? `https://raw.communitydragon.org/latest/plugins/rcp-be-lol-game-data/global/default/v1/perk-images/styles/${p.rune_style}/${p.runes}.png` : "";

                return `
                <div class="player-row ${isMe}">
                    <div class="c-champ"><img src="${CDN}/champion-icons/${p.champion_id}.png" style="width:32px; height:32px; border-radius:50%;"></div>
                    <div class="c-spells">
                        <img src="${D_DRAGON_IMG}/spell/${spell1}.png">
                        <img src="${D_DRAGON_IMG}/spell/${spell2}.png">
                    </div>
                    <div class="c-name">${p.name}</div>
                    <div class="c-opscore" style="font-size:10px; font-weight:bold; color:#aaa;">${p.op_score} ${badge}</div>
                    <div class="c-kda">${p.k}/${p.d}/${p.a}</div>
                    <div class="c-damage"><div class="dmg-bar"><div class="dmg-fill" style="width:${dmgPercent}%"></div></div></div>
                    <div class="c-wards">${p.wards_placed}</div>
                    <div class="c-cs">${p.cs}</div>
                    <div class="c-items">${items}</div>
                </div>`;
            };

            const html = `
            <div class="game-card ${resultClass}">
                <div class="game-summary">
                    <div class="info-col">
                        <div style="font-weight:bold; color:${isWin?'#5383e8':'#e84057'};">Ranked Solo</div>
                        <div class="result">${isWin?"Victory":"Defeat"}</div>
                        <div>${game.duration}</div>
                    </div>
                    <div class="champ-col">
                        <img src="${CDN}/champion-icons/${me.champion_id}.png" class="champ-icon">
                        <div class="spells">
                            <img src="${D_DRAGON_IMG}/spell/${spellMap[me.spells[0]]||'SummonerFlash'}.png" class="spell-img">
                            <img src="${D_DRAGON_IMG}/spell/${spellMap[me.spells[1]]||'SummonerFlash'}.png" class="spell-img">
                        </div>
                    </div>
                    <div class="kda-col">
                        <span class="kda-text">${me.k} / <span style="color:#e84057">${me.d}</span> / ${me.a}</span>
                        <span style="font-size:11px; opacity:0.7;">${me.kda_ratio}:1 KDA</span>
                    </div>
                    <div class="stats-col">
                        <div style="color:#e84057">P/Kill ${me.p_kill}%</div>
                        <div>Control Ward ${me.wards_control}</div>
                        <div>CS ${me.cs} (${me.cs_min})</div>
                        <div class="tier-badge" style="color:#fff; font-weight:bold;">${me.tier}</div>
                    </div>
                    <div class="items-col">
                        ${me.items.map(id => id ? `<div class="item-box"><img src="${D_DRAGON_IMG}/item/${id}.png"></div>` : `<div class="item-box"></div>`).join('')}
                    </div>
                    <button class="btn-expand" onclick="toggleDetails(${index})">▼</button>
                </div>
                <div id="detail-${index}" class="game-details">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                        <div class="team-blue">
                            <div class="team-header"><span>Blue Team</span> <span>Total Kills: ${game.total_kills_blue}</span></div>
                            ${game.teams.BLUE.map(renderPlayer).join('')}
                        </div>
                        <div class="team-red">
                            <div class="team-header"><span>Red Team</span> <span>Total Kills: ${game.total_kills_red}</span></div>
                            ${game.teams.RED.map(renderPlayer).join('')}
                        </div>
                    </div>
                </div>
            </div>`;
            container.innerHTML += html;
        });

        // Gestion bouton "Voir plus"
        if (displayedCount >= fullHistory.length) {
            document.getElementById('btn-load-more').style.display = 'none';
        } else {
            document.getElementById('btn-load-more').style.display = 'block';
        }
    }

    function loadMoreGames() {
        displayedCount += 20;
        renderGamesList();
    }

    function toggleDetails(id) {
        const el = document.getElementById(`detail-${id}`);
        el.style.display = (el.style.display === "block") ? "none" : "block";
    }
</script>
</body>
</html>